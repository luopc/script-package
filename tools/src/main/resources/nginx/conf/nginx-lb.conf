# 后端服务器组
upstream nexus_backend {
    server 192.168.3.121:8082;  # core.luopc.com
    # 可以添加更多Nexus服务器
    keepalive 32;
}

upstream grafana_backend {
    server 192.168.3.120:8090;  # data.luopc.com
    # 可以添加更多Grafana服务器
    keepalive 32;
}

upstream nacos_backend {
    server 192.168.3.120:7072;
    server 192.168.3.121:7072;
    server 192.168.3.111:7072;  # app.luopc.com
    # 可以添加更多Grafana服务器
    keepalive 32;
}

upstream gateway_backend {
    server 192.168.3.120:8095;
    server 192.168.3.121:8095;
    server 192.168.3.111:8095;
    server 192.168.3.110:8095;
    # 可以添加更多Grafana服务器
    keepalive 32;
}

# HTTP重定向到HTTPS
server {
    listen 80;
    server_name lb.luopc.com;
    return 301 https://$host$request_uri;
}

# HTTPS服务
server {
    listen 443 ssl;
    server_name lb.luopc.com;

    client_max_body_size 500M;  # 设置为实际需要的值，如500M或1G
    # SSL证书配置
    ssl_certificate     /opt/public/apps/mkcert/luopc.com.cert;
    ssl_certificate_key /opt/public/apps/mkcert/luopc.com.key;

    # SSL优化
    ssl_session_cache   shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # HSTS增强安全
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # Nexus代理配置
    location /nexus/ {
        proxy_pass http://nexus_backend/nexus/;

        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $host;

        # 超时设置
        proxy_connect_timeout 90;
        proxy_send_timeout 300;
        proxy_read_timeout 300;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    # Grafana代理配置
    location /grafana/ {
        proxy_pass http://grafana_backend/grafana/;

        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /nacos/ {
        proxy_pass http://nacos_backend/nacos/;

        # 代理头设置
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # WebSocket支持
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

    location /gateway/ {
            proxy_pass http://gateway_backend/gateway/;

            # 代理头设置
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket支持
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

    # 状态页面
    location /nginx_status {
        stub_status;
        allow 192.168.3.0/24;
        deny all;
    }

    # 根路径重定向
    location = / {
        root   rootPath/current/html/;
        index  index.html index.htm;
    }
    # 错误页面
    error_page 500 502 503 504 /50x.html;
}
